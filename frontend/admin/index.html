<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¸å¯è¯ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            margin: 0 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f9f9f9;
            font-weight: 600;
            color: #667eea;
        }

        .status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active { background: #d1fae5; color: #065f46; }
        .status-unused { background: #e0e7ff; color: #3730a3; }
        .status-expired { background: #fee2e2; color: #991b1b; }
        .status-banned { background: #fecaca; color: #7f1d1d; }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .hidden {
            display: none;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .code-box {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸ” è®¸å¯è¯ç®¡ç†ç³»ç»Ÿ</h1>
            <p>License Management System</p>
        </div>
    </div>

    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats">
            <div class="stat-card">
                <h3>æ€»è®¸å¯è¯æ•°</h3>
                <div class="value" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <h3>å·²æ¿€æ´»</h3>
                <div class="value" id="stat-active" style="color: #10b981;">0</div>
            </div>
            <div class="stat-card">
                <h3>æœªä½¿ç”¨</h3>
                <div class="value" id="stat-unused" style="color: #3b82f6;">0</div>
            </div>
            <div class="stat-card">
                <h3>å·²è¿‡æœŸ</h3>
                <div class="value" id="stat-expired" style="color: #ef4444;">0</div>
            </div>
        </div>

        <!-- ç”Ÿæˆè®¸å¯è¯ -->
        <div class="section">
            <h2>ç”Ÿæˆæ–°è®¸å¯è¯</h2>
            <div id="generate-alert" class="alert hidden"></div>
            <form id="generate-form">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>äº§å“åç§°</label>
                        <input type="text" id="product-name" value="Basic License" required>
                    </div>
                    <div class="form-group">
                        <label>æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label>
                        <input type="number" id="duration" value="30" required>
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§è®¾å¤‡æ•°</label>
                        <input type="number" id="max-devices" value="1" required>
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰</label>
                        <input type="number" id="user-id" placeholder="ç•™ç©ºè¡¨ç¤ºæ— å…³è”ç”¨æˆ·">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">ç”Ÿæˆè®¸å¯è¯</button>
            </form>
            <div id="generated-key" class="code-box hidden"></div>
        </div>

        <!-- è®¸å¯è¯åˆ—è¡¨ -->
        <div class="section">
            <h2>è®¸å¯è¯åˆ—è¡¨</h2>
            <div class="filter-group">
                <select id="filter-status">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="active">å·²æ¿€æ´»</option>
                    <option value="unused">æœªä½¿ç”¨</option>
                    <option value="expired">å·²è¿‡æœŸ</option>
                    <option value="banned">å·²å°ç¦</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="loadLicenses()">åˆ·æ–°</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="licenses-table">
                    <thead>
                        <tr>
                            <th>è®¸å¯è¯å¯†é’¥</th>
                            <th>äº§å“</th>
                            <th>çŠ¶æ€</th>
                            <th>HWID</th>
                            <th>è¿‡æœŸæ—¶é—´</th>
                            <th>æ¿€æ´»æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="licenses-tbody">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadLicenses();
        });

        // ç”Ÿæˆè®¸å¯è¯è¡¨å•æäº¤
        document.getElementById('generate-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                product_name: document.getElementById('product-name').value,
                duration: parseInt(document.getElementById('duration').value),
                max_devices: parseInt(document.getElementById('max-devices').value),
                user_id: parseInt(document.getElementById('user-id').value) || 0
            };

            try {
                const response = await fetch(`${API_BASE}/api/admin/license`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('generate-alert', `è®¸å¯è¯ç”ŸæˆæˆåŠŸï¼`, 'success');
                    document.getElementById('generated-key').textContent =
                        `è®¸å¯è¯å¯†é’¥: ${result.license_key}\näº§å“: ${result.product_name}\nè¿‡æœŸæ—¶é—´: ${new Date(result.expires_at).toLocaleString()}`;
                    document.getElementById('generated-key').classList.remove('hidden');

                    // é‡æ–°åŠ è½½ç»Ÿè®¡å’Œåˆ—è¡¨
                    loadStats();
                    loadLicenses();
                } else {
                    showAlert('generate-alert', result.error || 'ç”Ÿæˆå¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('generate-alert', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        });

        // çŠ¶æ€ç­›é€‰å˜åŒ–æ—¶é‡æ–°åŠ è½½
        document.getElementById('filter-status').addEventListener('change', loadLicenses);

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/stats`);
                const data = await response.json();

                document.getElementById('stat-total').textContent = data.licenses.total;
                document.getElementById('stat-active').textContent = data.licenses.active;
                document.getElementById('stat-unused').textContent = data.licenses.unused;
                document.getElementById('stat-expired').textContent = data.licenses.expired;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // åŠ è½½è®¸å¯è¯åˆ—è¡¨
        async function loadLicenses() {
            const status = document.getElementById('filter-status').value;
            const url = status ? `${API_BASE}/api/admin/licenses?status=${status}` : `${API_BASE}/api/admin/licenses`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                const tbody = document.getElementById('licenses-tbody');

                if (data.licenses && data.licenses.length > 0) {
                    tbody.innerHTML = data.licenses.map(license => `
                        <tr>
                            <td><code>${license.license_key}</code></td>
                            <td>${license.product_name}</td>
                            <td><span class="status status-${license.status}">${getStatusText(license.status)}</span></td>
                            <td>${license.hwid ? license.hwid.substring(0, 16) + '...' : '-'}</td>
                            <td>${new Date(license.expires_at).toLocaleDateString()}</td>
                            <td>${license.activated_at ? new Date(license.activated_at).toLocaleDateString() : '-'}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="updateStatus('${license.license_key}', 'active')">æ¿€æ´»</button>
                                <button class="btn btn-danger btn-sm" onclick="updateStatus('${license.license_key}', 'banned')">å°ç¦</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td></tr>';
                }
            } catch (error) {
                console.error('Failed to load licenses:', error);
                document.getElementById('licenses-tbody').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; color: #ef4444;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ›´æ–°è®¸å¯è¯çŠ¶æ€
        async function updateStatus(licenseKey, status) {
            if (!confirm(`ç¡®å®šè¦å°†è®¸å¯è¯çŠ¶æ€æ”¹ä¸º"${getStatusText(status)}"å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/license`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ license_key: licenseKey, status: status })
                });

                if (response.ok) {
                    alert('çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
                    loadStats();
                    loadLicenses();
                } else {
                    const error = await response.json();
                    alert('æ›´æ–°å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(id, message, type) {
            const alert = document.getElementById(id);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.classList.remove('hidden');

            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const map = {
                'active': 'å·²æ¿€æ´»',
                'unused': 'æœªä½¿ç”¨',
                'expired': 'å·²è¿‡æœŸ',
                'banned': 'å·²å°ç¦'
            };
            return map[status] || status;
        }
    </script>
</body>
</html>
