# è®¸å¯è¯éªŒè¯åæ–‡ä»¶é‡Šæ”¾æœºåˆ¶è¯´æ˜

## ğŸ”„ å®Œæ•´æµç¨‹

### 1. ç”¨æˆ·å¯åŠ¨ç¨‹åº
```
ç”¨æˆ·åŒå‡»: lzy_zte_è®¸å¯è¯éªŒè¯.exe
          â†“
å¯åŠ¨å™¨å¼€å§‹è¿è¡Œ
```

### 2. è®¸å¯è¯éªŒè¯
```
æ£€æŸ¥å·²ä¿å­˜çš„è®¸å¯è¯
          â†“
[å¦‚æœæœ‰] â†’ éªŒè¯è®¸å¯è¯ â†’ [éªŒè¯æˆåŠŸ] â†’ è¿›å…¥ç¬¬3æ­¥
          â†“
[å¦‚æœæ²¡æœ‰] â†’ è¦æ±‚è¾“å…¥è®¸å¯è¯ â†’ éªŒè¯ â†’ [éªŒè¯æˆåŠŸ] â†’ è¿›å…¥ç¬¬3æ­¥
```

### 3. æ–‡ä»¶é‡Šæ”¾ (è‡ªåŠ¨è¿›è¡Œ)
```
è°ƒç”¨ extract_embedded_program()
          â†“
ä»æ‰“åŒ…æ–‡ä»¶ä¸­æå– lzy_zte_12.10.exe
          â†“
é‡Šæ”¾åˆ°ç³»ç»Ÿä¸´æ—¶ç›®å½•
          â†“
è¿”å›é‡Šæ”¾åçš„æ–‡ä»¶è·¯å¾„
```

### 4. å¯åŠ¨ç¨‹åº
```
ä½¿ç”¨é‡Šæ”¾åçš„æ–‡ä»¶è·¯å¾„
          â†“
å¯åŠ¨ lzy_zte_12.10.exe
          â†“
å®Œæˆï¼
```

---

## ğŸ’» æŠ€æœ¯å®ç°ç»†èŠ‚

### æ–‡ä»¶é‡Šæ”¾æ ¸å¿ƒä»£ç  (launcher.py:118-160)

```python
def extract_embedded_program(self):
    """é‡Šæ”¾å†…åµŒçš„ç¨‹åºæ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰"""
    import shutil
    import tempfile

    if not self.target_exe:
        return None

    # 1. æ£€æŸ¥æ˜¯å¦æ‰“åŒ…ç¯å¢ƒ
    if not getattr(sys, 'frozen', False):
        # ä¸æ˜¯æ‰“åŒ…ç¯å¢ƒï¼ˆå¼€å‘æ¨¡å¼ï¼‰ï¼Œç›´æ¥è¿”å›åŸè·¯å¾„
        return self.target_exe if os.path.exists(self.target_exe) else None

    # 2. æ‰“åŒ…ç¯å¢ƒï¼ŒæŸ¥æ‰¾å†…åµŒçš„ç¨‹åº
    if hasattr(sys, '_MEIPASS'):
        # PyInstaller ä¸´æ—¶ç›®å½•
        embedded_path = os.path.join(sys._MEIPASS, self.target_exe)

        if os.path.exists(embedded_path):
            # 3. é‡Šæ”¾åˆ°ç³»ç»Ÿä¸´æ—¶ç›®å½•
            temp_dir = tempfile.gettempdir()
            extract_path = os.path.join(temp_dir, self.target_exe)

            # 4. ä¼˜åŒ–ï¼šå¦‚æœå·²å­˜åœ¨ä¸”æ˜¯æœ€æ–°çš„ï¼Œç›´æ¥ä½¿ç”¨
            if os.path.exists(extract_path):
                if os.path.getsize(embedded_path) == os.path.getsize(extract_path):
                    return extract_path

            # 5. å¤åˆ¶æ–‡ä»¶
            shutil.copy2(embedded_path, extract_path)

            # 6. macOS/Linux éœ€è¦æ·»åŠ æ‰§è¡Œæƒé™
            if platform.system() != 'Windows':
                os.chmod(extract_path, 0o755)

            return extract_path

    # æœªæ‰¾åˆ°å†…åµŒç¨‹åºï¼Œå°è¯•å½“å‰ç›®å½•
    if os.path.exists(self.target_exe):
        return self.target_exe

    return None
```

---

## ğŸ“‚ æ–‡ä»¶ä½ç½®è¯¦è§£

### æ‰“åŒ…æ—¶

```
lzy_zte_è®¸å¯è¯éªŒè¯ (35MB)
â”œâ”€â”€ å¯åŠ¨å™¨ä»£ç 
â”œâ”€â”€ Python è¿è¡Œæ—¶
â”œâ”€â”€ ä¾èµ–åº“ (requests, tkinter)
â”œâ”€â”€ launcher_config.json
â””â”€â”€ lzy_zte_12.10.exe (å†…åµŒ) â† è¿™é‡Œ
```

### è¿è¡Œæ—¶ (ç¬¬ä¸€æ¬¡è¿è¡Œ)

PyInstaller ä¼šè‡ªåŠ¨åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶è§£å‹æ‰€æœ‰èµ„æº:

**macOS:**
```
/var/folders/xxx/T/_MEIxxxxxx/
â”œâ”€â”€ æ‰€æœ‰ Python è¿è¡Œæ—¶æ–‡ä»¶
â”œâ”€â”€ launcher_config.json
â””â”€â”€ lzy_zte_12.10.exe â† PyInstaller è‡ªåŠ¨è§£å‹åˆ°è¿™é‡Œ
```

**Windows:**
```
C:\Users\ç”¨æˆ·å\AppData\Local\Temp\_MEIxxxxxx\
â”œâ”€â”€ æ‰€æœ‰ Python è¿è¡Œæ—¶æ–‡ä»¶
â”œâ”€â”€ launcher_config.json
â””â”€â”€ lzy_zte_12.10.exe â† PyInstaller è‡ªåŠ¨è§£å‹åˆ°è¿™é‡Œ
```

### é‡Šæ”¾å (éªŒè¯æˆåŠŸå)

å¯åŠ¨å™¨ä¼šå°† exe æ–‡ä»¶å¤åˆ¶åˆ°**å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨ç›®å½•**:

**macOS:**
```
dist/
â”œâ”€â”€ lzy_zte_è®¸å¯è¯éªŒè¯           # å¯åŠ¨å™¨ä¸»ç¨‹åº
â””â”€â”€ lzy_zte_12.10.exe            # â† é‡Šæ”¾åˆ°è¿™é‡Œ (ä¸å¯åŠ¨å™¨åŒç›®å½•)
```

**Windows:**
```
C:\Program Files\YourApp\
â”œâ”€â”€ lzy_zte_è®¸å¯è¯éªŒè¯.exe       # å¯åŠ¨å™¨ä¸»ç¨‹åº
â””â”€â”€ lzy_zte_12.10.exe            # â† é‡Šæ”¾åˆ°è¿™é‡Œ (ä¸å¯åŠ¨å™¨åŒç›®å½•)
```

**ä¼˜ç‚¹:**
- âœ… æ–‡ä»¶ä½ç½®å›ºå®š,æ˜“äºç®¡ç†
- âœ… ä¸å ç”¨ç³»ç»Ÿä¸´æ—¶ç›®å½•ç©ºé—´
- âœ… ç”¨æˆ·å¯ä»¥ç›´æ¥çœ‹åˆ°é‡Šæ”¾çš„æ–‡ä»¶
- âœ… ä¾¿äºå¸è½½å’Œæ¸…ç†

---

## ğŸ” å…³é”®æ¦‚å¿µ

### 1. sys._MEIPASS

è¿™æ˜¯ PyInstaller çš„ç‰¹æ®Šå˜é‡,æŒ‡å‘ä¸´æ—¶è§£å‹ç›®å½•:

```python
# ç¤ºä¾‹è·¯å¾„
macOS:   sys._MEIPASS = '/var/folders/xxx/T/_MEI123456/'
Windows: sys._MEIPASS = 'C:\\Users\\xxx\\AppData\\Local\\Temp\\_MEI123456\\'
```

### 2. tempfile.gettempdir()

**å·²åºŸå¼ƒ** - ç°åœ¨ä½¿ç”¨å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨ç›®å½•ã€‚

### æ–°æ–¹æ³•: sys.executable

è·å–å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„,ç„¶åæå–ç›®å½•:

```python
# è·å–å¯æ‰§è¡Œæ–‡ä»¶å®Œæ•´è·¯å¾„
exe_path = sys.executable
# ç¤ºä¾‹: /Users/xxx/dist/lzy_zte_è®¸å¯è¯éªŒè¯

# æå–ç›®å½•
exe_dir = os.path.dirname(os.path.abspath(sys.executable))
# ç¤ºä¾‹: /Users/xxx/dist/

# é‡Šæ”¾è·¯å¾„
extract_path = os.path.join(exe_dir, "lzy_zte_12.10.exe")
# ç¤ºä¾‹: /Users/xxx/dist/lzy_zte_12.10.exe
```

### 3. ä¸ºä»€ä¹ˆé‡Šæ”¾åˆ°åŒç›®å½•?

**ä¼˜ç‚¹:**
1. **ä½ç½®å›ºå®š** - æ–‡ä»¶å§‹ç»ˆåœ¨å¯åŠ¨å™¨æ—è¾¹
2. **æ˜“äºç®¡ç†** - ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç›¸å…³æ–‡ä»¶
3. **ä¾¿äºå¸è½½** - åˆ é™¤æ•´ä¸ªæ–‡ä»¶å¤¹å³å¯
4. **ä¸æ±¡æŸ“ç³»ç»Ÿ** - ä¸å ç”¨ä¸´æ—¶ç›®å½•ç©ºé—´
5. **ç¬¦åˆé¢„æœŸ** - ç”¨æˆ·æœŸæœ›ç¨‹åºæ–‡ä»¶åœ¨ä¸€èµ·

**ä»¥å‰ä½¿ç”¨ä¸´æ—¶ç›®å½•çš„é—®é¢˜:**
- âŒ æ–‡ä»¶åˆ†æ•£åœ¨ç³»ç»Ÿå„å¤„
- âŒ ä¸´æ—¶ç›®å½•å¯èƒ½è¢«æ¸…ç†
- âŒ ç”¨æˆ·ä¸çŸ¥é“æ–‡ä»¶åœ¨å“ª
- âŒ å¸è½½æ—¶ç•™ä¸‹åƒåœ¾æ–‡ä»¶

---

## âš¡ ä¼˜åŒ–æœºåˆ¶

### é¿å…é‡å¤é‡Šæ”¾

```python
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ç»å­˜åœ¨
if os.path.exists(extract_path):
    # æ¯”è¾ƒæ–‡ä»¶å¤§å°ï¼Œå¦‚æœç›¸åŒå°±ä¸é‡å¤å¤åˆ¶
    if os.path.getsize(embedded_path) == os.path.getsize(extract_path):
        return extract_path
```

**å¥½å¤„:**
- ç¬¬äºŒæ¬¡è¿è¡Œæ—¶ä¸éœ€è¦é‡æ–°å¤åˆ¶
- åŠ å¿«å¯åŠ¨é€Ÿåº¦
- å‡å°‘ç£ç›˜ IO

---

## ğŸ¯ å®Œæ•´ç¤ºä¾‹

### åœºæ™¯: ç”¨æˆ·ç¬¬ä¸€æ¬¡è¿è¡Œç¨‹åº

```
1. ç”¨æˆ·åŒå‡»: lzy_zte_è®¸å¯è¯éªŒè¯.exe
   ä½ç½®: C:\MyApp\lzy_zte_è®¸å¯è¯éªŒè¯.exe

2. PyInstaller è‡ªåŠ¨è§£å‹åˆ°:
   Windows: C:\Users\xxx\AppData\Local\Temp\_MEI123456\
   â”œâ”€â”€ Python è¿è¡Œæ—¶
   â”œâ”€â”€ launcher.py
   â”œâ”€â”€ launcher_config.json
   â””â”€â”€ lzy_zte_12.10.exe

3. å¯åŠ¨å™¨æ˜¾ç¤ºè®¸å¯è¯è¾“å…¥ç•Œé¢:
   ç”¨æˆ·è¾“å…¥: ABC-123-XYZ

4. è¿æ¥æœåŠ¡å™¨éªŒè¯:
   POST http://localhost:8080/api/activate
   âœ… éªŒè¯æˆåŠŸ

5. ä¿å­˜è®¸å¯è¯åˆ°å¯åŠ¨å™¨æ‰€åœ¨ç›®å½•:
   C:\MyApp\.license (éšè—æ–‡ä»¶)

6. è°ƒç”¨ extract_embedded_program():

   a) è¯»å–å†…åµŒæ–‡ä»¶:
      Source: C:\Users\xxx\AppData\Local\Temp\_MEI123456\lzy_zte_12.10.exe

   b) è·å–å¯åŠ¨å™¨æ‰€åœ¨ç›®å½•:
      exe_dir = os.path.dirname(sys.executable)
      Result: C:\MyApp\

   c) å¤åˆ¶åˆ°å¯åŠ¨å™¨åŒç›®å½•:
      Dest: C:\MyApp\lzy_zte_12.10.exe

   d) è®¾ç½®æ‰§è¡Œæƒé™ (macOS/Linux)

7. ç›®å½•ç»“æ„å˜åŒ–:
   C:\MyApp\
   â”œâ”€â”€ lzy_zte_è®¸å¯è¯éªŒè¯.exe     # å¯åŠ¨å™¨
   â”œâ”€â”€ lzy_zte_12.10.exe           # â† æ–°é‡Šæ”¾çš„æ–‡ä»¶
   â””â”€â”€ .license                    # è®¸å¯è¯ç¼“å­˜

8. å¯åŠ¨ç¨‹åº:
   Windows: subprocess.Popen(['C:\\MyApp\\lzy_zte_12.10.exe'])
   macOS:   subprocess.Popen(['wine', '/path/to/lzy_zte_12.10.exe'])

9. âœ… å®Œæˆï¼
```

### åœºæ™¯: ç”¨æˆ·ç¬¬äºŒæ¬¡è¿è¡Œç¨‹åº

```
1. ç”¨æˆ·åŒå‡»: lzy_zte_è®¸å¯è¯éªŒè¯.exe
   ä½ç½®: C:\MyApp\lzy_zte_è®¸å¯è¯éªŒè¯.exe

2. PyInstaller è‡ªåŠ¨è§£å‹ (åŒä¸Š)

3. å¯åŠ¨å™¨æ£€æŸ¥å·²ä¿å­˜çš„è®¸å¯è¯:
   è¯»å– C:\MyApp\.license
   âœ… æ‰¾åˆ°è®¸å¯è¯

4. éªŒè¯è®¸å¯è¯:
   POST http://localhost:8080/api/heartbeat
   âœ… éªŒè¯æˆåŠŸ

5. è°ƒç”¨ extract_embedded_program():

   a) æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨:
      C:\MyApp\lzy_zte_12.10.exe
      âœ… å·²å­˜åœ¨

   b) æ¯”è¾ƒæ–‡ä»¶å¤§å°:
      å†…åµŒæ–‡ä»¶: 25MB
      å·²å­˜åœ¨æ–‡ä»¶: 25MB
      âœ… ç›¸åŒï¼Œè·³è¿‡å¤åˆ¶

   c) ç›´æ¥è¿”å›è·¯å¾„:
      C:\MyApp\lzy_zte_12.10.exe

6. å¯åŠ¨ç¨‹åº (åŒä¸Š)

7. âœ… å®Œæˆï¼(æ›´å¿«ï¼Œæ— éœ€å¤åˆ¶)
```

---

## ğŸ› ï¸ è‡ªå®šä¹‰é‡Šæ”¾ä½ç½®

å¦‚æœæ‚¨æƒ³ä¿®æ”¹é‡Šæ”¾ä½ç½®,å¯ä»¥ç¼–è¾‘ `launcher.py` ç¬¬ 136-142 è¡Œ:

### å½“å‰ä»£ç  (ä½¿ç”¨å¯åŠ¨å™¨åŒç›®å½•):
```python
# è·å–å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨ç›®å½•
if hasattr(sys, 'executable'):
    exe_dir = os.path.dirname(os.path.abspath(sys.executable))
else:
    exe_dir = os.getcwd()

extract_path = os.path.join(exe_dir, self.target_exe)
```

### ä¿®æ”¹ä¸ºç³»ç»Ÿä¸´æ—¶ç›®å½•:
```python
import tempfile
temp_dir = tempfile.gettempdir()  # /tmp æˆ– C:\Users\xxx\AppData\Local\Temp
extract_path = os.path.join(temp_dir, self.target_exe)
```

### ä¿®æ”¹ä¸ºç”¨æˆ·ä¸»ç›®å½•:
```python
temp_dir = os.path.expanduser("~/MyApp")  # ç”¨æˆ·ä¸»ç›®å½•ä¸‹çš„ MyApp æ–‡ä»¶å¤¹
os.makedirs(temp_dir, exist_ok=True)  # ç¡®ä¿ç›®å½•å­˜åœ¨
extract_path = os.path.join(temp_dir, self.target_exe)
```

### ä¿®æ”¹ä¸ºå›ºå®šç›®å½•:
```python
# Windows
temp_dir = "C:\\Program Files\\MyApp"
# macOS
temp_dir = "/Applications/MyApp"

os.makedirs(temp_dir, exist_ok=True)  # ç¡®ä¿ç›®å½•å­˜åœ¨
extract_path = os.path.join(temp_dir, self.target_exe)
```

**æ³¨æ„:** ä¿®æ”¹åéœ€è¦é‡æ–°æ‰“åŒ…!

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥

å½“å‰ä½¿ç”¨æ–‡ä»¶å¤§å°åˆ¤æ–­:
```python
os.path.getsize(embedded_path) == os.path.getsize(extract_path)
```

**å¢å¼ºæ–¹æ¡ˆ (å¯é€‰):** ä½¿ç”¨ SHA256 æ ¡éªŒå’Œ:

```python
import hashlib

def get_file_hash(filepath):
    sha256 = hashlib.sha256()
    with open(filepath, 'rb') as f:
        while chunk := f.read(8192):
            sha256.update(chunk)
    return sha256.hexdigest()

# æ¯”è¾ƒ
if get_file_hash(embedded_path) == get_file_hash(extract_path):
    return extract_path
```

### 2. æƒé™è®¾ç½®

macOS/Linux è‡ªåŠ¨è®¾ç½®æ‰§è¡Œæƒé™:
```python
os.chmod(extract_path, 0o755)
# 0o755 = rwxr-xr-x (æ‰€æœ‰è€…å¯è¯»å†™æ‰§è¡Œï¼Œå…¶ä»–äººå¯è¯»æ‰§è¡Œ)
```

---

## ğŸ“Š æ€§èƒ½æ•°æ®

åŸºäº lzy_zte_12.10.exe (25MB):

| æ“ä½œ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| é¦–æ¬¡é‡Šæ”¾ | ~0.5-1ç§’ | éœ€è¦å¤åˆ¶ 25MB æ–‡ä»¶ |
| åç»­è¿è¡Œ | ~0.01ç§’ | ä»…æ£€æŸ¥æ–‡ä»¶å¤§å° |
| å¯åŠ¨ç¨‹åº | ~1-3ç§’ | å–å†³äºç¨‹åºæœ¬èº« |

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ‰¾ä¸åˆ°ç¨‹åº

**ç—‡çŠ¶:**
```
âŒ æ‰¾ä¸åˆ°ç¨‹åº: lzy_zte_12.10.exe
```

**å¯èƒ½åŸå› :**
1. æ‰“åŒ…æ—¶æ²¡æœ‰åŒ…å« exe æ–‡ä»¶
2. launcher_config.json ä¸­ target_exe é…ç½®é”™è¯¯

**è§£å†³:**
```bash
# æ£€æŸ¥é…ç½®
cat launcher_config.json

# åº”è¯¥åŒ…å«
{
  "target_exe": "lzy_zte_12.10.exe"
}

# é‡æ–°æ‰“åŒ…
build_with_program.bat  # Windows
./build_with_program.sh # macOS/Linux
```

### é—®é¢˜ 2: æ²¡æœ‰æ‰§è¡Œæƒé™ (macOS/Linux)

**ç—‡çŠ¶:**
```
Permission denied
```

**è§£å†³:**
ä»£ç å·²è‡ªåŠ¨å¤„ç†:
```python
if platform.system() != 'Windows':
    os.chmod(extract_path, 0o755)
```

### é—®é¢˜ 3: Wine æœªå®‰è£… (macOS/Linux è¿è¡Œ Windows ç¨‹åº)

**ç—‡çŠ¶:**
```
âŒ å¯åŠ¨å¤±è´¥: [Errno 2] No such file or directory: 'wine'
```

**è§£å†³:**
```bash
# macOS
brew install wine-stable

# Linux (Ubuntu/Debian)
sudo apt install wine
```

---

## ğŸ“ æ€»ç»“

### æ–‡ä»¶é‡Šæ”¾æœºåˆ¶çš„å…³é”®ç‚¹:

1. âœ… **è‡ªåŠ¨åŒ–**: ç”¨æˆ·æ— éœ€æ‰‹åŠ¨æ“ä½œ
2. âœ… **ä¼˜åŒ–**: é¿å…é‡å¤é‡Šæ”¾
3. âœ… **è·¨å¹³å°**: æ”¯æŒ Windows/macOS/Linux
4. âœ… **å®‰å…¨**: è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
5. âœ… **é€æ˜**: ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°å¤åˆ¶è¿‡ç¨‹

### ç”¨æˆ·ä½“éªŒ:

**ç”¨æˆ·è§†è§’:**
```
åŒå‡»ç¨‹åº â†’ è¾“å…¥è®¸å¯è¯ â†’ ç¨‹åºè‡ªåŠ¨å¯åŠ¨
```

**å®é™…è¿‡ç¨‹:**
```
åŒå‡»ç¨‹åº â†’ PyInstaller è§£å‹ â†’ éªŒè¯è®¸å¯è¯ â†’ é‡Šæ”¾æ–‡ä»¶ â†’ å¯åŠ¨ç¨‹åº
```

ç”¨æˆ·å®Œå…¨ä¸éœ€è¦å…³å¿ƒæŠ€æœ¯ç»†èŠ‚,åªéœ€è¦çŸ¥é“éªŒè¯æˆåŠŸåç¨‹åºä¼šè‡ªåŠ¨å¯åŠ¨! ğŸ‰

---

**åˆ›å»ºæ—¶é—´**: 2025-12-14
**é€‚ç”¨ç‰ˆæœ¬**: launcher.py v1.0
